<project>

  <property name="testDir" location="${buildDir}/test" />

  <property name="junit.sysprop.java.util.logging.config.file" 
            value="${basedir}/resources/jar/tracing.properties"/>

  <!-- Override this target to do project specific preparations -->
  <target name="junit:depends" />

  <target name="junit:setup" depends="setup" 
          description="Prepare for JUnit Basic Tests">
    <mkdir dir="${testDir}" />
    <!-- Sets default value for junit.system.properties -->
    <propertyset id="junit.system.properties">
      <propertyref prefix="junit.sysprop."/>
        <globmapper from="junit.sysprop.*" to="*"/>
    </propertyset>
    <property name="junit.jvm.args" value="-Dkey=value" />
    <path id="junit.override.path" />
    <path id="junit.class.path">
      <pathelement path="C:\Program Files\Eclipse 3.2\eclipse\plugins\org.junit4_4.1.0.1\junit-4.1.jar"/> 
    </path>
    <path id="junit.src.path">
      <pathelement path="${basedir}/test"/>
    </path>
    <!-- Basic test sources -->
    <patternset id="junit.bt.sources">
      <include name="**/*Test.java"/>
      <exclude name="**/*GUITest.java"/>
    </patternset>    
    <!-- Basic integration test sources -->
    <patternset id="junit.bit.sources">
      <include name="**/*BIT.java"/>
    </patternset>    
    <!-- Basic gui test sources -->
    <patternset id="junit.bgt.sources">
      <include name="**/*GUITest.java"/>
    </patternset>    
  </target>

  <target name="junit:clean" description="Removes temporary JUnit Basic files">
    <delete dir="${testDir}" />
  </target>

  <target name="junit:compile" depends="junit:setup, junit:depends" 
          description="Compile JUnit Basic Tests"> 
    <javac destdir="${testDir}" debug="on" encoding="ISO-8859-1">
      <src refid="junit.src.path"/>
      <classpath>
        <path refid="jar.class.path" />
        <path refid="junit.class.path"/>
        <pathelement location="${outputDir}"/>
      </classpath>
    </javac>
  </target>
  
  <target name="junit:run" unless="skipbasictest" >
    <echo message="Running ${junit.type.msg}" />
    <junit printsummary="yes" haltonfailure="no">
      <jvmarg value="${junit.jvm.args}" />
      <syspropertyset refid="junit.system.properties" />
      <classpath>
        <path refid="junit.override.path" />
        <pathelement location="${testDir}"/>
        <pathelement location="${jarfile}"/>
        <path refid="junit.class.path"/>
        <path refid="jar.class.path"/>
      </classpath>
      <env key="${junit.env.key1}" path="${junit.env.value1}" />
      <env key="${junit.env.key2}" path="${junit.env.value2}" />
      <formatter type="brief" usefile="no" />
      <formatter type="xml" />

      <batchtest fork="yes" todir="${testDir}">
        <fileset dir="${basedir}/test">
          <patternset refid="junit.src.filter"/>
        </fileset>
      </batchtest>
    </junit>
  </target>
  
  <target name="junit:single" depends="junit:compile" 
          description="Run a single test. Use -Dtestcase=mytestcase" >
    <patternset id="junit.single.sources">
      <include name="**/${testcase}.java"/>
    </patternset>
        
    <!-- Run basic integration tests -->
    <antcall target="junit:run" inheritRefs="true">
      <reference refid="junit.single.sources" torefid="junit.src.filter"/>
      <reference refid="junit.override.path" torefid="junit.override.path" />
      <reference refid="junit.class.path" torefid="junit.class.path"/>
      <reference refid="jar.class.path" torefid="jar.class.path"/>
      <reference refid="junit.system.properties" torefid="junit.system.properties"/>
      <param name="junit.type.msg" value="single test"/>
    </antcall>
  </target>

  <target name="junit:bt" depends="junit:compile" 
          description="Run junit basic test" >
    <!-- Run basic tests -->
    <antcall target="junit:run" inheritRefs="true">
      <reference refid="junit.bt.sources" torefid="junit.src.filter"/>
      <reference refid="junit.override.path" torefid="junit.override.path" />
      <reference refid="junit.class.path" torefid="junit.class.path"/>
      <reference refid="jar.class.path" torefid="jar.class.path"/>
      <reference refid="junit.system.properties" torefid="junit.system.properties"/>
      <param name="junit.type.msg" value="basic test"/>
    </antcall>
  </target>

  <target name="junit:bit" depends="junit:compile" 
          description="Run junit basic integration test" >
    <!-- Run basic integration tests -->
    <antcall target="junit:run" inheritRefs="true">
      <reference refid="junit.bit.sources" torefid="junit.src.filter"/>
      <reference refid="junit.override.path" torefid="junit.override.path" />
      <reference refid="junit.class.path" torefid="junit.class.path"/>
      <reference refid="jar.class.path" torefid="jar.class.path"/>
      <reference refid="junit.system.properties" torefid="junit.system.properties"/>
      <param name="junit.type.msg" value="basic integration test"/>
    </antcall>
  </target>

  <target name="junit:bgt" depends="junit:compile" 
          description="Run junit basic gui test" >
    <!-- Run basic integration tests -->
    <antcall target="junit:run">
      <reference refid="junit.bgt.sources" torefid="junit.src.filter"/>
      <reference refid="junit.override.path" torefid="junit.override.path" />
      <reference refid="junit.class.path" torefid="junit.class.path"/>
      <reference refid="jar.class.path" torefid="jar.class.path"/>
      <reference refid="junit.system.properties" torefid="junit.system.properties"/>
      <param name="junit.type.msg" value="basic GUI test"/>
    </antcall>
  </target>
  
  <target name="junit" depends="junit:compile" 
          description="Run all JUnit Tests">
    <antcall target="junit:run" inheritRefs="true"> <!-- basic tests -->
      <reference refid="junit.bt.sources" torefid="junit.src.filter"/>
      <reference refid="junit.override.path" torefid="junit.override.path" />
      <reference refid="junit.class.path" torefid="junit.class.path"/>
      <reference refid="jar.class.path" torefid="jar.class.path"/>
      <reference refid="junit.system.properties" torefid="junit.system.properties"/>
      <param name="junit.type.msg" value="basic test"/>
    </antcall>
    <antcall target="junit:run" inheritRefs="true"> <!-- basic integration tests -->
      <reference refid="junit.bit.sources" torefid="junit.src.filter"/>
      <reference refid="junit.override.path" torefid="junit.override.path" />
      <reference refid="junit.class.path" torefid="junit.class.path"/>
      <reference refid="jar.class.path" torefid="jar.class.path"/>
      <reference refid="junit.system.properties" torefid="junit.system.properties"/>
      <param name="junit.type.msg" value="basic integration test"/>
    </antcall>
    <antcall target="junit:run" inheritRefs="true"> <!-- basic gui tests -->
      <reference refid="junit.bgt.sources" torefid="junit.src.filter"/>
      <reference refid="junit.override.path" torefid="junit.override.path" />
      <reference refid="junit.class.path" torefid="junit.class.path"/>
      <reference refid="jar.class.path" torefid="jar.class.path"/>
      <reference refid="junit.system.properties" torefid="junit.system.properties"/>
      <param name="junit.type.msg" value="basic GUI test"/>
    </antcall>
  </target>
  
  <target name="junit:report">
    <mkdir dir="${testDir}/reports" />
    <junitreport todir="${testDir}/reports">
      <fileset dir="${testDir}">
        <include name="TEST-*.xml"/>
      </fileset>
      <report format="frames" todir="${testDir}/reports/html"/> 
    </junitreport>  
  </target>
   
</project>